<!doctype html>
<html ng-app>
	<head>
		<link rel="stylesheet" type="text/css" href="css/animate.css" />
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<script src="js/angular.js"></script>
		<script>
		var fs = require('fs');
		var moment = require('moment');
		var Imagemin = require('imagemin');
		var path = require('path');
	    var async = require('async');


		var ctx;
		var canvas;
		var localMediaStream;
		var video;
		var sources;

		var constraints = {
			video: {
				mandatory: {
			      	minWidth: 1920,
			      	minHeight: 1080
			    },
			    optional: []
			}
		}

		function init(callback) {
			MediaStreamTrack.getSources(function (src) {
        		sources = [];
        		src.forEach(function (s) {
        			if (s.kind === 'video') {
        				sources.push(s);
        			}
        		});
        		constraints.video.optional.push({sourceId: localStorage.sourceId || src[0].id});

        		video = document.getElementById('vid');
				canvas = document.getElementById('can');
        		navigator.webkitGetUserMedia(constraints, function (stream) {
					video.src = window.URL.createObjectURL(stream);
					localMediaStream = stream;
					callback(null);
				}, function (err) {
					console.error(err);
					callback(err);
				});
		    });
		}

		function snapshot(saveFilePath, doTimestamp, callback) {
			if (localMediaStream) {
				// draw the image onto the canvas first
				canvas.height = video.videoHeight;
				canvas.width = video.videoWidth;
				ctx = canvas.getContext('2d');
			  	ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

			  	if (doTimestamp) {
			  		ctx.fillStyle = "#ffffff";
					ctx.font = "14px Tahoma";
				  	ctx.fillText(moment().format('llll'), 10, 20);
			  	}
			  	
			  	// process the data
				var canvasData = canvas.toDataURL('image/png');
				var imageText = canvasData.split(',')[1]; // split off the beginning metadata
			  	var imageBuffer = new Buffer(imageText, 'base64');
			  	
			  	// save it to the file system
			  	fs.writeFile(saveFilePath, imageBuffer, {encoding: 'base64'}, function (err) {
			  		if (err) {
			  			return callback(err, null);
			  		}

		  			// compress the image and write it over itself
		  			var imagemin = new Imagemin()
					    .src(saveFilePath)
					    .dest(saveFilePath)
					    .use(Imagemin.pngquant());

					imagemin.optimize(function (err, file) {
					    if (err) {
					    	return callback(err, file);
					    }
				    	// set it as the thumbnail
					  	document.getElementById('img').src = canvasData;
	  					callback(null, saveFilePath);
					});

			  	});
			}
		} 


		function MainController($scope) {

			init(function (err) {
				if (err) {
					$scope.errMessage = err;
					return;
				}
				$scope.sources = sources;
				$scope.$apply();
			});

			// Settings
			var DEFAULT_DATE = "YYYYMMDD HH.mm.ss.SSS";

			$scope.dateFormat = localStorage.dateFormat || DEFAULT_DATE;
			$scope.saveFolder = localStorage.saveFolder || "/Users/jpx/Downloads";
			$scope.errMessage = "";
			$scope.message = "";
			$scope.sourceId = localStorage.sourceId || null;
			$scope.enableTimestamp = localStorage.enableTimestamp === 'true' ? true : false;
			$scope.folderSize = "";
			$scope.maxFolderBytes = localStorage.maxFolderBytes ? parseFloat(localStorage.maxFolderBytes) : 1024 * 1024 * 1024 * 20; // 20gb
			$scope.proposedGb = ($scope.maxFolderBytes / 1024 / 1024 / 1024).toFixed(2);

			function getReadableSize(inputBytes) {
				var outText = "";
				var mb = 1024 * 1024;
				var gb = mb * 1024;
				if (inputBytes < gb) {
					outText = (inputBytes / mb).toFixed(2) + "mb";
				}
				else {
					outText = (inputBytes / gb).toFixed(2) + "gb";
				}
				return outText;
			}

			$scope.sources = []; // reference

			$scope.snapInterval = localStorage.snapInterval ? parseFloat(localStorage.snapInterval) : 5000;
			$scope.autosnapEnabled = localStorage.autosnapEnabled === 'true' ? true : false;

			var snapLooper = function () {
				console.log('Autosnap', $scope.autosnapEnabled);
				if ($scope.autosnapEnabled) {
					$scope.snap();
				}
				setTimeout(snapLooper, $scope.snapInterval);
			};

			$scope.checkFolderSize = function () {
				$scope.errMessage = "";

				// a bit of validation - dont let it end in trailing slash
				if ($scope.saveFolder[$scope.saveFolder.length - 1] === "/" && $scope.saveFolder.length > 1) {
					$scope.saveFolder = $scope.saveFolder.substring(0, $scope.saveFolder.length - 1);
					$scope.saveSaveFolder();
				}

				readSizeRecursive($scope.saveFolder, function (err, bytes) {
					if (err) {
						$scope.errMessage = err;
						$scope.$apply();
						return;
					}

					var files = fs.readdirSync($scope.saveFolder);

					files.sort(function (a, b) {
						if (a < b) return 1;
						if (a > b) return -1;
						return 1;
					});
					
					// remove the eldest files while there are too many bytes
					while (files.length && bytes > $scope.maxFolderBytes) {
						try {
							var file = $scope.saveFolder + "/" + files.pop();
							if (file[0] === '.') continue;

							var fileBytes = fs.lstatSync(file).size;
							bytes -= fileBytes;
							fs.unlinkSync(file);
						}
						catch (ex) {
							$scope.errMessage = ex;
							console.error(ex.stack);
							$scope.$apply();
							return;
						}
					}

					$scope.folderSize = getReadableSize(bytes);
					$scope.$apply();
				});
			};

			$scope.snap = function () {
				$scope.message = "";
				$scope.errMessage = "";
				var saveFilePath = $scope.saveFolder + '/' + moment().format($scope.dateFormat) + '.png';
				snapshot(saveFilePath, $scope.enableTimestamp, function (err, filepath) {
					if (err) {
						$scope.errMessage = err;
					}
					else {
						$scope.message = "Saved to " + filepath;
					}
					$scope.checkFolderSize();
				});
			};

			$scope.saveDateFormat = function () {
				localStorage.dateFormat = $scope.dateFormat || DEFAULT_DATE;
				$scope.message = "Filename format changed to " + $scope.dateFormat;
			};
			$scope.saveSaveFolder = function () {
				localStorage.saveFolder = $scope.saveFolder;
				$scope.message = "Save folder changed to " + $scope.saveFolder;
			};
			$scope.saveSnapInterval = function () {
				localStorage.snapInterval = $scope.snapInterval;
				$scope.message = "Snap interval changed to " + $scope.snapInterval;
			};
			$scope.toggleSnapEnabled = function () {
				$scope.autosnapEnabled = !$scope.autosnapEnabled;
				localStorage.autosnapEnabled = $scope.autosnapEnabled;
				$scope.message = "System has been " + ($scope.autosnapEnabled ? "enabled" : "disabled") + ".";
			};
			$scope.saveEnableTimestamp = function () {
				localStorage.enableTimestamp = $scope.enableTimestamp;
				$scope.message = "Image timestamp set to " + ($scope.enableTimestamp ? "enabled" : "disabled") + ".";
			};
			$scope.saveMaxFolderBytes = function () {
				// $scope.proposedGb
				if (isNaN($scope.proposedGb)) {
					$scope.errMessage = "Invalid max gigabytes - must be a number.";
					return;
				}
				
				$scope.errMessage = "";
				$scope.maxFolderBytes = parseFloat($scope.proposedGb) * 1024 * 1024 * 1024;
				localStorage.maxFolderBytes = $scope.maxFolderBytes;
				$scope.message = "Set max image folder size to " + $scope.proposedGb;
			};


			$scope.setSource = function () {
				localStorage.sourceId = $scope.sourceId;
				window.location.reload();
			};
			


			snapLooper();
			$scope.checkFolderSize();
		}


		function readSizeRecursive(item, cb) {
		  fs.lstat(item, function (err, stats) {
		  	if (err) return cb(err);

		    var total = stats.size;

		    if (!err && stats.isDirectory()) {
		      fs.readdir(item, function(err, list) {
		        if (err) return cb(err);

		        async.forEach(
		          list,
		          function(diritem, callback) {
		            readSizeRecursive(path.join(item, diritem), function(err, size) {
		              total += size;
		              callback(err);
		            }); 
		          },  
		          function(err) {
		            cb(err, total);
		          }   
		        );  
		      }); 
		    }   
		    else {
		      cb(err, total);
		    }   
		  }); 
		}   
		</script>
	</head>
	<body>
		<br />
		<br />
		<div ng-controller="MainController" class="container">
			<div class="row">
				<div class="col-sm-4">
					<div class="btn-group">
						<button type="checkbox" class="btn btn-default btn-xl"
							ng-disabled="!autosnapEnabled" 
							ng-click="toggleSnapEnabled()">
							OFF
							<span ng-show="!autosnapEnabled">
								&nbsp;
								<i class="fa fa-check-circle-o"></i>
							</span>
						</button>
						<button type="checkbox" class="btn btn-default"
							ng-disabled="autosnapEnabled" 
							ng-click="toggleSnapEnabled()">
							ON
							<span ng-show="autosnapEnabled">
								&nbsp;
								<i class="fa fa-check-circle-o"></i>
							</span>
						</button>
					</div>

					<br />
					<br />
					<br />
					<br />
					<button class="btn btn-default btn-sm" ng-class="{active:preview}" ng-click="preview = !preview">
						preview
					</button>
					<button class="btn btn-default btn-sm" ng-class="{active:settings}" ng-click="settings = !settings">
						advanced settings
					</button>
				</div>
				<div class="col-sm-8">
					<select class="form-control" ng-model="sourceId" ng-change="setSource()">
						<option ng-repeat="source in sources" 
							ng-selected="source.id === sourceId"
							value="{{source.id}}"> {{ source.label }} </option>
					</select>
					
					<br />

					<label>
						Save folder
						<span class="help-inline">{{ folderSize }}</span>
					</label>
					<input class="form-control" type="text" ng-model="saveFolder" 
						ng-blur="checkFolderSize()"
						ng-change="saveSaveFolder()" value="" />
				</div>
				
			</div>
			
			<div class="row" ng-show="settings">					
				<br />
				<div class="col-sm-4">
					<label>Max image folder size in gigabytes (gb)</label>
					<input type="text" class="form-control" ng-model="proposedGb"
						ng-change="saveMaxFolderBytes()" />
					<div class="checkbox">
						<label>
							<input type="checkbox" ng-model="enableTimestamp" 
								ng-change="saveEnableTimestamp()" value="" />
								Timestamp the images
						</label>
					</div>
				</div>
				<div class="col-sm-4">
					<label>Autosnap interval (miliseconds)</label>
					<input class="form-control" type="text" ng-model="snapInterval" 
						ng-change="saveSnapInterval()" value="" />
				</div>
				<div class="col-sm-4">
					<label>File format 
						(see 
						<a href="http://momentjs.com/docs/#/displaying/" 
							target="_blank">moment.js</a>)
					</label>
					<input class="form-control" type="text" ng-model="dateFormat" ng-change="saveDateFormat()" value="" />
				</div>
			</div>
			
			<hr />
			<p ng-show="errMessage" class="text-danger">{{ errMessage }}</p>
			<p ng-show="message" class="text-info">{{ message }}</p>
			
			<div class="row" ng-show="preview">
				<div class="col-sm-8">
					<span class="help-block">Turn off preview to save energy.</span>
					<video ng-click="snap()" class="img-responsive" id="vid" autoplay></video>
				</div>
				<div class="col-sm-4">
					<label>Last photo</label>
					<img id="img" class="img-responsive img-thumbnail" src="">
				</div>
				<br />
				<br />
				<br />
			</div>
			
			<canvas id="can"></canvas>
		</div>
	</body>
</html>